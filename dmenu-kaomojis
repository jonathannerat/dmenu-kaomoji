#!/bin/sh

# dmenu based kaomoji chooser, so i don't have to open kaomoji.ru everytime

# change this to -ix if you're using the printindex patch
printindex_opt="-I"

die() {
	>&2 echo "$@"
	exit 1
}

usage() {
	die "usage: ${0##*/} [FILE] [DMENU_OPTS]\n"\
"options:\n"\
"\tFILE          path to kaomojis.tsv file generated by get_kaomojis.py,\n"\
"\t              defaults to \$XDG_CACHE_HOME/kaomojis.tsv or\n"\
"\t              \$HOME/.cache/kaomojis.tsv\n"
"\tDMENU_OPTS    options to passthrough to dmenu"
}

if [ -f "$1" ]; then
	kaomojisfile="$1"
	shift
else
	kaomojisfile="${XDG_CACHE_HOME:-$HOME/.cache}/kaomojis.tsv"
	[ -f "$kaomojisfile" ] || usage
fi

index=$(tail -n+2 "$kaomojisfile" | while IFS='	' read -r id cat kao desc; do
	echo "$kao [$cat]${desc:+: $desc}"
done | dmenu "$printindex_opt" "$@")

if [ -n "$index" ]; then
	kaomoji=$(tail -n+"$((index+2))" "$kaomojisfile" | head -n1 | cut -d'	' -f3)
	echo "$kaomoji" | tr -d '\n' | xclip -selection clipboard
fi
